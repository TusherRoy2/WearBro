<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WearBro | Checkout</title>
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"
    />
    <link rel="stylesheet" href="style.css" />
  </head>

  <body class="bg-white text-gray-900">
    <div id="app">
      <header class="custom_bg text-white shadow">
        <div
          class="navContainer max-w-7xl mx-auto px-4 py-4 flex justify-between items-center"
        >
          <a href="index.html"
            ><img id="logo" src="logo.png" alt="WearBro"
          /></a>
          <nav class="space-x-6 hidden md:flex">
            <a href="/" class="hover:underline">Home</a>
            <a href="about.html" class="hover:underline">About Us</a>
            <a href="product.html" class="hover:underline">Products</a>
            <a href="policy.html" class="hover:underline">Privacy Policy</a>
            <a href="cart.html" class="hover:underline">Cart</a>
            <a href="#contact" class="hover:underline">Contact</a>
          </nav>
        </div>
        <div class="navBar">
          <i class="fa-solid fa-bars-staggered"></i>
          <i class="fa-solid fa-xmark"></i>
        </div>
      </header>

      <div class="mobileMenu">
        <ul class="">
          <li><a href="/">Home</a></li>
          <li><a href="about.html">About Us</a></li>
          <li><a href="product.html">Products</a></li>
          <li><a href="policy.html">Privacy Policy</a></li>
          <li><a href="cart.html">Cart</a></li>
          <li><a href="#contact">Contact</a></li>
        </ul>
      </div>

      <div class="text-scroller">
        <p>
          “আমাদের সেবা সারা বাংলাদেশ জুড়ে ক্যাশ অন ডেলিভারির মাধ্যমে প্রদান করা
          হয়, এবং রয়েছে সহজ ও নির্ভরযোগ্য রিটার্ন ও এক্সচেঞ্জ পলিসি।”
        </p>
      </div>

      <section class="py-12 bg-gray-50">
        <div class="max-w-6xl mx-auto px-4">
          <h2 class="text-4xl font-bold text-center mb-10">Checkout</h2>

          <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div
              class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg border border-gray-200"
            >
              <h3 class="text-2xl font-semibold mb-6 pb-3 custom_txt border-b">
                Shipping Information
              </h3>

              <form id="checkoutForm" class="space-y-4">
                <input
                  type="text"
                  name="name"
                  placeholder="Full Name (সম্পূর্ণ নাম)"
                  required
                  class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                />

                <input
                  type="number"
                  name="phone"
                  placeholder="Phone Number (ফোন নম্বর)"
                  required
                  class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                />

                <textarea
                  name="address"
                  placeholder="Full Address (সম্পূর্ণ ঠিকানা: বাসা, রাস্তা, এলাকা, শহর)"
                  rows="3"
                  required
                  class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                ></textarea>

                <div class="pt-4 border-t mt-6">
                  <h4 class="text-xl font-semibold mb-3">
                    Payment Method (পেমেন্ট পদ্ধতি)
                  </h4>
                  <div
                    class="bg-gray-100 p-4 rounded-lg flex items-center shadow-inner"
                  >
                    <input
                      type="radio"
                      id="cod"
                      name="payment_method"
                      value="COD"
                      checked
                      class="mr-3 w-5 h-5 text-blue-600 focus:ring-blue-500"
                    />
                    <label for="cod" class="text-gray-800 font-medium text-lg">
                      Cash On Delivery (ক্যাশ অন ডেলিভারি)
                    </label>
                  </div>
                </div>

                <button
                  type="submit"
                  class="w-full custom_bg text-white font-bold py-3 rounded-lg hover:opacity-90 transition-opacity mt-6 text-xl shadow-md"
                >
                  Place Order (অর্ডার করুন)
                </button>
              </form>
            </div>

            <div
              class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg border border-gray-200 lg:sticky lg:top-4 h-fit"
            >
              <h3 class="text-2xl font-semibold mb-6 pb-3 custom_txt border-b">
                Your Order Summary
              </h3>

              <div id="cartSummary" class="space-y-4">
                <div id="product-list-container"></div>

                <div class="space-y-3 pt-4 border-t-2 border-blue-100">
                  <div class="flex justify-between text-gray-700">
                    <span>Subtotal:</span>
                    <span id="subtotal-display">৳0</span>
                  </div>
                  <div class="flex justify-between text-gray-700">
                    <span>Delivery Charge:</span>
                    <span id="shipping-display">৳100</span>
                  </div>
                  <div
                    class="flex justify-between text-2xl font-bold pt-3 custom_txt border-t"
                  >
                    <span>Total Payable:</span>
                    <span id="total-display">৳100</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section id="contact" class="py-16"></section>

      <footer class="custom_bg text-white py-6 text-center">
        <p>&copy; 2025 WearBro. All rights reserved.</p>
      </footer>
    </div>

    <script>
      const scriptURL =
        "https://script.google.com/macros/s/AKfycbz7fgOkhnZ99dJgFaiJu7i70pP1LokCNstGOwSV29DD4yxQGS1RsSxhjJi15idrJrx4/exec"; // আপনার Google Apps Script URL এটিই থাকবে

      const SHIPPING_COST = 100; // আপনার ডেলিভারি চার্জ

      // ✅ ফাংশন ১: কার্ট সামারি ডিসপ্লে করা
      function displayCartSummary() {
        const cart = JSON.parse(localStorage.getItem("cart")) || [];
        const productListContainer = document.getElementById(
          "product-list-container"
        );

        if (!productListContainer) return;
        productListContainer.innerHTML = ""; // পূর্বের কন্টেন্ট মুছে ফেলা

        let subtotal = 0;

        if (cart.length === 0) {
          productListContainer.innerHTML =
            '<p class="text-red-500 font-medium">Your cart is empty!</p>';
          subtotal = 0;
        } else {
          cart.forEach((item) => {
            const itemTotal = item.price * (item.quantity || 1);
            subtotal += itemTotal;

            const itemHtml = `
                      <div class="flex justify-between items-center py-2 border-b">
                          <span class="text-gray-700 font-medium">
                              ${item.name} (x${item.quantity || 1})
                          </span>
                          <span class="font-semibold text-gray-800">৳${itemTotal.toLocaleString(
                            "en-IN"
                          )}</span>
                      </div>
                  `;
            productListContainer.innerHTML += itemHtml;
          });
        }

        const totalPayable = subtotal + SHIPPING_COST;

        // ডিসপ্লে আপডেট করা
        document.getElementById(
          "subtotal-display"
        ).textContent = `৳${subtotal.toLocaleString("en-IN")}`;
        document.getElementById(
          "shipping-display"
        ).textContent = `৳${SHIPPING_COST}`;
        document.getElementById(
          "total-display"
        ).textContent = `৳${totalPayable.toLocaleString("en-IN")}`;
      }

      // ✅ ফাংশন ২: অর্ডার সাবমিট করা
      document
        .getElementById("checkoutForm")
        .addEventListener("submit", async (e) => {
          // async যোগ করা হয়েছে
          e.preventDefault();

          const submitButton = e.target.querySelector('button[type="submit"]');
          const originalButtonText = submitButton.textContent;

          // লোডিং স্টেট সেট করা
          submitButton.textContent = "Processing... ⏳";
          submitButton.disabled = true;

          try {
            // LocalStorage থেকে কার্ট ডেটা নেওয়া
            const cart = JSON.parse(localStorage.getItem("cart")) || [];
            if (cart.length === 0) {
              alert(
                "Your cart is empty. Please add products before placing an order."
              );
              submitButton.textContent = originalButtonText;
              submitButton.disabled = false;
              return;
            }

            // পণ্যের নাম এবং মোট মূল্য গণনা করা (Google Sheet-এর জন্য)
            const productNames = cart
              .map((item) => `${item.name} (Qty: ${item.quantity || 1})`)
              .join(", ");
            const totalPrice = cart.reduce(
              (sum, item) => sum + item.price * (item.quantity || 1),
              0
            );
            const totalPayableWithShipping = totalPrice + SHIPPING_COST; // ডেলিভারি চার্জ যোগ করা হয়েছে

            // ফর্ম ডেটা তৈরি করা
            const formData = new FormData(e.target);
            formData.append("products", productNames);
            formData.append("subtotal", totalPrice); // Subtotal পাঠানো হলো
            formData.append("shipping", SHIPPING_COST); // Shipping cost পাঠানো হলো
            formData.append("total", totalPayableWithShipping); // মোট মূল্য পাঠানো হলো
            formData.append("dateTime", new Date().toLocaleString()); // সময় যোগ করা

            // Google Sheet এ পাঠানো
            const response = await fetch(scriptURL, {
              method: "POST",
              body: formData,
              mode: "no-cors",
            });

            // ধরে নেওয়া হলো fetch সফল হয়েছে

            localStorage.removeItem("cart");
            window.location.href = "thankyou.html";
          } catch (err) {
            // NetworkError (CORS) এখানে ধরা পড়বে
            alert(
              "Order submission failed. Please ensure you are online and refresh the page. Details: " +
                err.message
            );
            console.error("Fetch Error:", err);
          } finally {
            // লোডিং স্টেট রিসেট করা
            submitButton.textContent = originalButtonText;
            submitButton.disabled = false;
          }
        });

      // পেজ লোড হওয়ার সাথে সাথে কার্ট সামারি দেখানোর জন্য কল করা হলো
      document.addEventListener("DOMContentLoaded", displayCartSummary);
    </script>

    <script src="products.js"></script>
    <script src="script.js"></script>
  </body>
</html>
